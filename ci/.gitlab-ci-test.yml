run_tests:
  stage: test
  image:
    name: $MACHINES_CONTAINER_REG/leg/builder-full:latest
    entrypoint: [""]
  needs: [install-gamsdist-leg]
  script:
    - yum install -y wget
    - wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    - sh Miniconda3-latest-Linux-x86_64.sh -b -p anaconda3
    - source anaconda3/bin/activate
    - conda create -y -n transfer-env python=3.8
    - conda activate transfer-env
    - GAMS_PATH=$(pwd)/gamsdist
    - echo $GAMS_LICENSE > $GAMS_PATH/gamslice.txt
    - PATH=$GAMS_PATH:$PATH
    - pip install gams[transfer] --find-links $GAMS_PATH/api/python/bdist
    - pip install wheel build
    - python -m build
    - python tests/test_gamspy.py
    - if [ "$?" == "0" ]; then echo "All tests passed!"; else exit 1; fi
    - coverage report -m --data-file=".coverage"
    - coverage xml --data-file=".coverage"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: '/TOTAL.*\s+(\d+\%)/'
